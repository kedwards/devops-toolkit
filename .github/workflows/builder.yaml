name: Build DevOps Toolkit Images
on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - ".github/workflows/builder.yaml"

  pull_request:
    branches:
      - main
    paths:
      - "src/**"
      - ".github/workflows/builder.yaml"
jobs:
  tester:
    runs-on: ubuntu-latest
    outputs:
      a1804: ${{ steps.test_ubuntu_base_1804.outputs.ubuntu_base_1804}}
    steps:
      - name: checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: check filters
        uses: dorny/paths-filter@v2
        id: filter
        with:
          base: main
          filters: |
            ubuntu_base_1804:
              - 'src/ansible/ubuntu18.04/**'
            ubuntu_base_2004:
              - 'src/ansible/ubuntu20.04/**'
            ubuntu_core_1804:
              - 'src/ansible-core/ubuntu18.04/**'
            ubuntu_core_2004:
              - 'src/ansible-core/ubuntu20.04/**'

      - name: Ubuntu 18.04 Base Test
        id: test_ubuntu_base_1804
        if: steps.filter.outputs.ubuntu_base_1804 == 'true'
        run: |
            echo ::set-output name=ubuntu_base_1804::true

  ubuntu_base_1804:
    runs-on: ubuntu-latest
    needs: tester
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: checkout repository
        uses: actions/checkout@v3
        with:
          path: 'src/ansible/ubunut18.04'

      - name: Ubuntu 18.04 Builder
        working-directory: src/ansible/ubuntu18.04
        # if: needs.tester.outputs.ubuntu_base_1804 == 'true'
        run: |
          cd src/ansible/ubuntu18.04
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/devops-toolkit:ubuntu_base_1804 .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/devops-toolkit:ubuntu_base_1804

      # - name: ubuntu 20.04 builder
      #   if: steps.filter.outputs.a2004 == 'true'
      #   uses: docker/build-push-action@v2
      #   with:
      #     path: ./src/ansible/ubuntu20.04
      #     push: true
      #     tags: kevinedwards/devops-toolkit:20

      # - name: Ubuntu 18.04 - Core builder
      #   if: steps.filter.outputs.ac1804 == 'true'
      #   uses: docker/build-push-action@v2
      #   with:
      #     path: ./src/ansible-core/ubuntu18.04
      #     push: true
      #     tags: kevinedwards/devops-toolkit:core18

      # - name: ubuntu 20.04 Core builder
      #   if: steps.filter.outputs.ac2004 == 'true'
      #   uses: docker/build-push-action@v2
      #   with:
      #     path: ./src/ansible-core/ubuntu20.04
      #     push: true
      #     tags: kevinedwards/devops-toolkit:core20